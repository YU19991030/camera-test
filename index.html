<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>PaddleOCR å³æ™‚è¾¨è­˜</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background: #f5f5f5; }
    video { display: block; margin: 0 auto; width: 100%; max-width: 360px; }
    #result, #finalArea { margin-top: 20px; font-size: 16px; white-space: pre-wrap; }
    button {
      margin: 10px 5px;
      padding: 8px 16px;
      font-size: 16px;
      border: 2px solid #333;
      border-radius: 6px;
      background-color: white;
      color: black;
    }
    #finalArea {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
  <!-- åŠ å…¥ Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <h2>ğŸ“· PaddleOCR å³æ™‚æ–‡å­—è¾¨è­˜</h2>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div>
    <button id="startBtn">ğŸ” é–‹å§‹è¾¨è­˜</button>
    <button id="stopBtn" disabled>âœ… å®Œæˆæƒæ</button>
  </div>

  <p id="result">ğŸ“„ ç­‰å¾…è¾¨è­˜ä¸­...</p>

  <div id="finalArea">
    <h3>ğŸ“ è¾¨è­˜çµæœï¼š</h3>
    <p id="finalText"></p>
    <button id="voiceBtn">ğŸ™ èªéŸ³è¼¸å…¥</button>
    <button id="confirmSave" style="display:none;">ğŸ’¾ ç¢ºèªå„²å­˜</button>
    <button onclick="location.reload()">âœ… å®Œæˆ</button>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const result = document.getElementById("result");
    const finalText = document.getElementById("finalText");
    const ctx = canvas.getContext("2d");

    let timer = null;
    let latestText = "";

    // === OCR æƒæéƒ¨åˆ† ===
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, audio: false
    }).then(stream => {
      video.srcObject = stream;
    }).catch(err => alert("âš ï¸ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼š" + err));

    document.getElementById("startBtn").onclick = () => {
      result.textContent = "é–‹å§‹è¾¨è­˜ä¸­...";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;

      timer = setInterval(() => {
        if (video.videoWidth === 0) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png");

        fetch("https://de50-125-228-143-171.ngrok-free.app/ocr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: imageData })
        })
        .then(res => res.json())
        .then(data => {
          const text = data.text?.trim();
          if (text) {
            latestText = text;
            result.textContent = "æœ€æ–°è¾¨è­˜ï¼š\n" + text;
          } else {
            result.textContent = "æ­£åœ¨è¾¨è­˜ä¸­...";
          }
        })
        .catch(err => {
          result.textContent = "âŒ éŒ¯èª¤ï¼š" + err;
        });
      }, 2000);
    };

    document.getElementById("stopBtn").onclick = () => {
      clearInterval(timer);
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;

      document.getElementById("finalText").textContent = latestText || "âš ï¸æ²’æœ‰è¾¨è­˜åˆ°ä»»ä½•æ–‡å­—";
      document.getElementById("finalArea").style.display = "block";
      result.style.display = "none";
      video.style.display = "none";
    };

    // === èªéŸ³è¼¸å…¥ï¼ˆSocketIO + éŒ„éŸ³ï¼‰ ===
    const socket = io("https://de50-125-228-143-171.ngrok-free.app");  // âœ… æ›¿æ›ç‚ºä½ çš„ ngrok åŸŸå
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("voiceBtn").onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        document.getElementById("voiceBtn").textContent = "ğŸ™ éŒ„éŸ³ä¸­... é»æˆ‘åœæ­¢";
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const arrayBuffer = await audioBlob.arrayBuffer();
          socket.emit("audio", { audio: arrayBuffer });
          document.getElementById("voiceBtn").textContent = "ğŸ™ èªéŸ³è¼¸å…¥";
        };

        socket.emit("start_recording");
        mediaRecorder.start();
      } else {
        mediaRecorder.stop();
        socket.emit("stop_recording");
      }
    };

    let finalVoiceText = "";  // å…¨å±€è®Šæ•¸å­˜æœ€å¾ŒèªéŸ³çµæœ

    socket.on("transcription", data => {
      if (data.text) {
        finalVoiceText = data.text;
        finalText.textContent = "ğŸ¤ èªéŸ³è¾¨è­˜çµæœï¼š\n" + data.text;
        document.getElementById("confirmSave").style.display = "inline-block";
      }
    });
    document.getElementById("confirmSave").onclick = () => {
      fetch("https://de50-125-228-143-171.ngrok-free.app/save_transcription", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: finalVoiceText })
      })
      .then(res => res.json())
      .then(data => {
        alert("âœ… æˆåŠŸå„²å­˜èªéŸ³çµæœï¼");
        document.getElementById("confirmSave").style.display = "none";
      })
      .catch(err => {
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + err);
      });
    };

  </script>
</body>
</html>
